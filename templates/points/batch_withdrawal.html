{% extends "horizontal_base.html" %}
{% load static %}

{% block title %}批量提现{% endblock title %}

{% block extra_css %}
    <style>
        .withdrawal-input-group {
            max-width: 200px;
        }
    </style>
{% endblock extra_css %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center flex-wrap grid-margin">
        <div>
            <h4 class="mb-3 mb-md-0">批量提现</h4>
        </div>
        <div class="d-flex align-items-center flex-wrap text-nowrap">
            <a href="{% url 'points:my_points' %}" class="btn btn-outline-secondary btn-icon-text mb-2 mb-md-0">
                <i data-lucide="arrow-left" class="btn-icon-prepend"></i> 返回积分页面
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12 grid-margin stretch-card">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">
                        <i data-lucide="wallet" class="icon-sm"></i> 选择要提现的积分池
                    </h6>
                    <p class="text-muted mb-4">请为每个要提现的积分池设置提现数量，留空表示不提现该积分池</p>

                    <form method="post" class="forms-sample" id="batchWithdrawalForm">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger" role="alert">
                                <i data-lucide="alert-circle" class="icon-sm"></i>
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Withdrawable Point Sources Table -->
                        <div class="table-responsive mb-4">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>获得时间</th>
                                        <th>初始积分</th>
                                        <th>剩余积分</th>
                                        <th>标签</th>
                                        <th>提现数量</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for source in withdrawable_sources %}
                                        <tr>
                                            <td>{{ source.created_at|date:"Y-m-d H:i" }}</td>
                                            <td>{{ source.initial_points }}</td>
                                            <td class="text-success fw-bold">{{ source.remaining_points }}</td>
                                            <td>
                                                {% for tag in source.tags.all %}
                                                    <span class="badge {% if tag.withdrawable %}bg-success{% else %}bg-secondary{% endif %} me-1">
                                                        {{ tag.name }}
                                                        {% if tag.withdrawable %}
                                                            <i data-lucide="check-circle" class="icon-xs ms-1"></i>
                                                        {% endif %}
                                                    </span>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <div class="input-group withdrawal-input-group">
                                                    <input
                                                        type="number"
                                                        name="points_{{ source.id }}"
                                                        class="form-control withdrawal-amount-input"
                                                        placeholder="提现数量"
                                                        min="0"
                                                        max="{{ source.remaining_points }}"
                                                        data-max="{{ source.remaining_points }}"
                                                    >
                                                    <button
                                                        type="button"
                                                        class="btn btn-sm btn-outline-secondary fill-max-btn"
                                                        data-target="points_{{ source.id }}"
                                                        data-max="{{ source.remaining_points }}"
                                                    >
                                                        全部
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="alert alert-info mb-4" role="alert">
                            <i data-lucide="info" class="icon-sm"></i>
                            <strong>提示：</strong>
                            <ul class="mb-0 mt-2">
                                <li>您可以选择一个或多个积分池进行提现</li>
                                <li>点击"全部"按钮可以快速设置为该积分池的全部剩余积分</li>
                                <li>提现数量不能超过积分池的剩余积分</li>
                            </ul>
                        </div>

                        <hr>

                        <!-- Withdrawal Information Form -->
                        <h6 class="card-title mt-4">
                            <i data-lucide="user-check" class="icon-sm"></i> 提现人信息
                        </h6>
                        <p class="text-muted mb-4">请填写真实的提现信息，这些信息将用于审核和打款</p>

                        {% if require_contract_signing %}
                            {% if signed_contract %}
                                <div class="alert alert-success" role="alert">
                                    <i data-lucide="check-circle" class="icon-sm"></i>
                                    已完成提现合同签署（{{ signed_contract.signed_at|date:"Y-m-d H:i"|default:"未知时间" }}），以下信息来自已签署合同。
                                </div>
                            {% elif pending_contract %}
                                <div class="alert alert-info" role="alert">
                                    <i data-lucide="message-square" class="icon-sm"></i>
                                    您已发起提现合同签署（记录ID: #{{ pending_contract.id }}），请查收短信完成签署后再继续提交提现申请。
                                </div>
                            {% else %}
                                <div class="alert alert-warning" role="alert">
                                    <i data-lucide="alert-triangle" class="icon-sm"></i>
                                    提现前需要先签署合同。本次提交将发起短信签署，签署完成后将自动提交提现申请。
                                </div>
                            {% endif %}
                        {% endif %}

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.real_name.id_for_label }}" class="form-label">{{ form.real_name.label }}{% if form.real_name.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                {{ form.real_name }}
                                {% if form.real_name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.real_name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.id_number.id_for_label }}" class="form-label">{{ form.id_number.label }}{% if form.id_number.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                {{ form.id_number }}
                                {% if form.id_number.errors %}
                                    <div class="text-danger">
                                        {% for error in form.id_number.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.phone_number.id_for_label }}" class="form-label">{{ form.phone_number.label }}{% if form.phone_number.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                {{ form.phone_number }}
                                {% if form.phone_number.errors %}
                                    <div class="text-danger">
                                        {% for error in form.phone_number.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.bank_name.id_for_label }}" class="form-label">{{ form.bank_name.label }}{% if form.bank_name.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                {{ form.bank_name }}
                                {% if form.bank_name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.bank_name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="col-md-12 mb-3">
                                <label for="{{ form.bank_account.id_for_label }}" class="form-label">{{ form.bank_account.label }}{% if form.bank_account.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                {{ form.bank_account }}
                                {% if form.bank_account.errors %}
                                    <div class="text-danger">
                                        {% for error in form.bank_account.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="alert alert-warning" role="alert">
                            <i data-lucide="alert-triangle" class="icon-sm"></i>
                            <strong>重要提示：</strong>
                            <ul class="mb-0 mt-2">
                                <li>请确保您填写的信息真实准确，否则可能导致提现失败</li>
                                {% if require_contract_signing and not signed_contract %}
                                    <li>提交后将先发起合同签署，请查收短信完成签署</li>
                                    <li>签署完成后将自动提交提现申请，并进入管理员审核流程</li>
                                {% else %}
                                    <li>提现申请提交后需要等待管理员审核</li>
                                    <li>审核通过后，积分将被扣除，款项将转入您的银行账户</li>
                                {% endif %}
                                <li>批量提现将为每个积分池创建单独的提现申请</li>
                            </ul>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <div>
                                <span class="text-muted">预计提现总积分：</span>
                                <span class="fs-4 fw-bold text-primary ms-2" id="totalPoints">0</span>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-primary me-2" {% if require_contract_signing and pending_contract and not signed_contract %}disabled{% endif %}>
                                    <i data-lucide="send" class="btn-icon-prepend"></i>
                                    {% if require_contract_signing and not signed_contract %}
                                        发起签署
                                    {% else %}
                                        提交申请
                                    {% endif %}
                                </button>
                                <a href="{% url 'points:my_points' %}" class="btn btn-outline-secondary">取消</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block plugin_js %}{% endblock plugin_js %}

{% block custom_js %}
    <script>
        // Initialize Lucide icons after page load
        lucide.createIcons();

        // Fill max button functionality
        document.querySelectorAll('.fill-max-btn').forEach(button => {
            button.addEventListener('click', function() {
                const targetName = this.getAttribute('data-target');
                const maxValue = this.getAttribute('data-max');
                const input = document.querySelector(`input[name="${targetName}"]`);
                if (input) {
                    input.value = maxValue;
                    updateTotalPoints();
                }
            });
        });

        // Calculate total points when inputs change
        function updateTotalPoints() {
            let total = 0;
            document.querySelectorAll('.withdrawal-amount-input').forEach(input => {
                const value = parseInt(input.value) || 0;
                if (value > 0) {
                    total += value;
                }
            });
            document.getElementById('totalPoints').textContent = total;
        }

        // Add event listeners to all amount inputs
        document.querySelectorAll('.withdrawal-amount-input').forEach(input => {
            input.addEventListener('input', updateTotalPoints);
        });

        // Validate form before submission
        document.getElementById('batchWithdrawalForm').addEventListener('submit', function(e) {
            let hasAmount = false;
            document.querySelectorAll('.withdrawal-amount-input').forEach(input => {
                const value = parseInt(input.value) || 0;
                const max = parseInt(input.getAttribute('data-max')) || 0;

                if (value > 0) {
                    hasAmount = true;
                    if (value > max) {
                        e.preventDefault();
                        alert(`提现数量不能超过剩余积分 ${max}`);
                        input.focus();
                        return false;
                    }
                }
            });

            if (!hasAmount) {
                e.preventDefault();
                alert('请至少为一个积分池设置提现数量');
                return false;
            }
        });

        // Initialize total points on page load
        updateTotalPoints();
    </script>
{% endblock custom_js %}
