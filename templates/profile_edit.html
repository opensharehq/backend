{% extends "horizontal_base.html" %}

{% block title %}编辑个人资料{% endblock title %}

{% block extra_css %}
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock extra_css %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center flex-wrap grid-margin">
        <div>
            <h4 class="mb-3 mb-md-0">编辑个人资料</h4>
        </div>
        <div class="d-flex align-items-center flex-wrap text-nowrap">
            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary btn-icon-text mb-2 mb-md-0">
                <i data-lucide="arrow-left" class="btn-icon-prepend"></i> 返回
            </a>
        </div>
    </div>
    <div class="row">
        <div class="col-12 col-xl-12">
            <form method="post" novalidate>
                {% csrf_token %}
                <!-- 基本资料卡片 -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i data-lucide="user" class="icon-sm"></i> 基本资料
                        </h6>
                        <div class="mb-3">
                            <label for="{{ form.bio.id_for_label }}" class="form-label">个人简介</label>
                            {{ form.bio }}
                            {% if form.bio.errors %}
                                <div class="invalid-feedback d-block">{{ form.bio.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">最多 500 字符</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.birth_date.id_for_label }}" class="form-label">生日</label>
                                {{ form.birth_date }}
                                {% if form.birth_date.errors %}
                                    <div class="invalid-feedback d-block">{{ form.birth_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.company.id_for_label }}" class="form-label">公司</label>
                                {{ form.company }}
                                {% if form.company.errors %}
                                    <div class="invalid-feedback d-block">{{ form.company.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.location.id_for_label }}" class="form-label">位置</label>
                            {{ form.location }}
                            {% if form.location.errors %}
                                <div class="invalid-feedback d-block">{{ form.location.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- 社交链接卡片 -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i data-lucide="link" class="icon-sm"></i> 社交链接
                        </h6>
                        <div class="mb-3">
                            <label for="{{ form.github_url.id_for_label }}" class="form-label">
                                <i data-lucide="github" class="icon-sm"></i> GitHub
                            </label>
                            {{ form.github_url }}
                            {% if form.github_url.errors %}
                                <div class="invalid-feedback d-block">{{ form.github_url.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.homepage_url.id_for_label }}" class="form-label">
                                <i data-lucide="home" class="icon-sm"></i> 个人主页
                            </label>
                            {{ form.homepage_url }}
                            {% if form.homepage_url.errors %}
                                <div class="invalid-feedback d-block">{{ form.homepage_url.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.blog_url.id_for_label }}" class="form-label">
                                <i data-lucide="book-open" class="icon-sm"></i> 博客
                            </label>
                            {{ form.blog_url }}
                            {% if form.blog_url.errors %}
                                <div class="invalid-feedback d-block">{{ form.blog_url.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.twitter_url.id_for_label }}" class="form-label">
                                <i data-lucide="twitter" class="icon-sm"></i> Twitter
                            </label>
                            {{ form.twitter_url }}
                            {% if form.twitter_url.errors %}
                                <div class="invalid-feedback d-block">{{ form.twitter_url.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.linkedin_url.id_for_label }}" class="form-label">
                                <i data-lucide="linkedin" class="icon-sm"></i> LinkedIn
                            </label>
                            {{ form.linkedin_url }}
                            {% if form.linkedin_url.errors %}
                                <div class="invalid-feedback d-block">{{ form.linkedin_url.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- 工作经历卡片 -->
                <div class="card mb-3" x-data="workExperienceManager({{ work_formset.total_form_count }})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title mb-0">
                                <i data-lucide="briefcase" class="icon-sm"></i> 工作经历
                            </h6>
                            <button type="button" class="btn btn-sm btn-primary btn-icon-text" @click="addForm()">
                                <i data-lucide="plus-circle" class="btn-icon-prepend"></i> 添加工作经历
                            </button>
                        </div>
                        {{ work_formset.management_form }}
                        <template id="work-form-template">
                            <div class="border rounded p-3 mb-3 formset-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">公司名称</label>
                                        <input type="text" name="work_experiences-__prefix__-company_name" class="form-control">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">职位</label>
                                        <input type="text" name="work_experiences-__prefix__-title" class="form-control">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">开始日期</label>
                                        <input type="date" name="work_experiences-__prefix__-start_date" class="form-control">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">结束日期 <small class="text-muted">(留空表示至今)</small></label>
                                        <input type="date" name="work_experiences-__prefix__-end_date" class="form-control">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">工作描述</label>
                                    <textarea name="work_experiences-__prefix__-description" rows="3" class="form-control"></textarea>
                                </div>
                                <input type="hidden" name="work_experiences-__prefix__-id">
                                <button type="button" class="btn btn-sm btn-outline-danger btn-icon-text" x-on:click="$el.closest('.formset-form').remove(); formCount--;">
                                    <i data-lucide="trash-2" class="btn-icon-prepend"></i> 删除
                                </button>
                            </div>
                        </template>
                        <div id="work-formset">
                            {% for work_form in work_formset %}
                                <div class="border rounded p-3 mb-3 formset-form">
                                    {{ work_form.id }}
                                    {% if work_form.non_field_errors %}
                                        <div class="alert alert-danger" role="alert">{{ work_form.non_field_errors.0 }}</div>
                                    {% endif %}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ work_form.company_name.id_for_label }}" class="form-label">
                                                公司名称 {% if work_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ work_form.company_name }}
                                            {% if work_form.company_name.errors %}
                                                <div class="invalid-feedback d-block">{{ work_form.company_name.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ work_form.title.id_for_label }}" class="form-label">
                                                职位 {% if work_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ work_form.title }}
                                            {% if work_form.title.errors %}
                                                <div class="invalid-feedback d-block">{{ work_form.title.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ work_form.start_date.id_for_label }}" class="form-label">
                                                开始日期 {% if work_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ work_form.start_date }}
                                            {% if work_form.start_date.errors %}
                                                <div class="invalid-feedback d-block">{{ work_form.start_date.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ work_form.end_date.id_for_label }}" class="form-label">
                                                结束日期 <small class="text-muted">(留空表示至今)</small>
                                            </label>
                                            {{ work_form.end_date }}
                                            {% if work_form.end_date.errors %}
                                                <div class="invalid-feedback d-block">{{ work_form.end_date.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ work_form.description.id_for_label }}" class="form-label">工作描述</label>
                                        {{ work_form.description }}
                                        {% if work_form.description.errors %}
                                            <div class="invalid-feedback d-block">{{ work_form.description.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    {% if work_form.instance.pk %}
                                        <div class="form-check">
                                            {{ work_form.DELETE }}
                                            <label class="form-check-label text-danger" for="{{ work_form.DELETE.id_for_label }}">删除此工作经历</label>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- 学习经历卡片 -->
                <div class="card mb-3" x-data="educationManager({{ education_formset.total_form_count }})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title mb-0">
                                <i data-lucide="graduation-cap" class="icon-sm"></i> 学习经历
                            </h6>
                            <button type="button" class="btn btn-sm btn-primary btn-icon-text" @click="addForm()">
                                <i data-lucide="plus-circle" class="btn-icon-prepend"></i> 添加学习经历
                            </button>
                        </div>
                        {{ education_formset.management_form }}
                        <template id="education-form-template">
                            <div class="border rounded p-3 mb-3 formset-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">学校/机构名称</label>
                                        <input type="text" name="educations-__prefix__-institution_name" class="form-control">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">学位</label>
                                        <input type="text" name="educations-__prefix__-degree" class="form-control">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">专业领域</label>
                                    <input type="text" name="educations-__prefix__-field_of_study" class="form-control">
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">开始日期</label>
                                        <input type="date" name="educations-__prefix__-start_date" class="form-control">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">结束日期 <small class="text-muted">(留空表示至今)</small></label>
                                        <input type="date" name="educations-__prefix__-end_date" class="form-control">
                                    </div>
                                </div>
                                <input type="hidden" name="educations-__prefix__-id">
                                <button type="button" class="btn btn-sm btn-outline-danger btn-icon-text" x-on:click="$el.closest('.formset-form').remove(); formCount--;">
                                    <i data-lucide="trash-2" class="btn-icon-prepend"></i> 删除
                                </button>
                            </div>
                        </template>
                        <div id="education-formset">
                            {% for edu_form in education_formset %}
                                <div class="border rounded p-3 mb-3 formset-form">
                                    {{ edu_form.id }}
                                    {% if edu_form.non_field_errors %}
                                        <div class="alert alert-danger" role="alert">{{ edu_form.non_field_errors.0 }}</div>
                                    {% endif %}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ edu_form.institution_name.id_for_label }}" class="form-label">
                                                学校/机构名称 {% if edu_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ edu_form.institution_name }}
                                            {% if edu_form.institution_name.errors %}
                                                <div class="invalid-feedback d-block">{{ edu_form.institution_name.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ edu_form.degree.id_for_label }}" class="form-label">学位</label>
                                            {{ edu_form.degree }}
                                            {% if edu_form.degree.errors %}
                                                <div class="invalid-feedback d-block">{{ edu_form.degree.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ edu_form.field_of_study.id_for_label }}" class="form-label">
                                            专业领域 {% if edu_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        {{ edu_form.field_of_study }}
                                        {% if edu_form.field_of_study.errors %}
                                            <div class="invalid-feedback d-block">{{ edu_form.field_of_study.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ edu_form.start_date.id_for_label }}" class="form-label">
                                                开始日期 {% if edu_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ edu_form.start_date }}
                                            {% if edu_form.start_date.errors %}
                                                <div class="invalid-feedback d-block">{{ edu_form.start_date.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ edu_form.end_date.id_for_label }}" class="form-label">
                                                结束日期 <small class="text-muted">(留空表示至今)</small>
                                            </label>
                                            {{ edu_form.end_date }}
                                            {% if edu_form.end_date.errors %}
                                                <div class="invalid-feedback d-block">{{ edu_form.end_date.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if edu_form.instance.pk %}
                                        <div class="form-check">
                                            {{ edu_form.DELETE }}
                                            <label class="form-check-label text-danger" for="{{ edu_form.DELETE.id_for_label }}">删除此学习经历</label>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- 收货地址卡片 -->
                <div class="card mb-3" x-data="addressManager({{ address_formset.total_form_count }})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="card-title mb-0">
                                <i data-lucide="map-pin" class="icon-sm"></i> 收货地址
                            </h6>
                            <button type="button" class="btn btn-sm btn-primary btn-icon-text" @click="addForm()">
                                <i data-lucide="plus-circle" class="btn-icon-prepend"></i> 添加收货地址
                            </button>
                        </div>
                        {{ address_formset.management_form }}
                        <template id="address-form-template">
                            <div class="border rounded p-3 mb-3 formset-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">收件人姓名</label>
                                        <input type="text"
                                               name="shipping_addresses-__prefix__-receiver_name"
                                               class="form-control">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">联系电话</label>
                                        <input type="text" name="shipping_addresses-__prefix__-phone" class="form-control">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">省份</label>
                                        <input type="text" name="shipping_addresses-__prefix__-province" class="form-control">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">城市</label>
                                        <input type="text" name="shipping_addresses-__prefix__-city" class="form-control">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">区/县</label>
                                        <input type="text" name="shipping_addresses-__prefix__-district" class="form-control">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">详细地址</label>
                                    <input type="text" name="shipping_addresses-__prefix__-address" class="form-control">
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox"
                                           name="shipping_addresses-__prefix__-is_default"
                                           class="form-check-input"
                                           id="id_shipping_addresses-__prefix__-is_default">
                                    <label class="form-check-label" for="id_shipping_addresses-__prefix__-is_default">设为默认地址</label>
                                </div>
                                <input type="hidden" name="shipping_addresses-__prefix__-id">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger btn-icon-text"
                                        x-on:click="$el.closest('.formset-form').remove(); formCount--;">
                                    <i data-lucide="trash-2" class="btn-icon-prepend"></i> 删除
                                </button>
                            </div>
                        </template>
                        <div id="address-formset">
                            {% for addr_form in address_formset %}
                                <div class="border rounded p-3 mb-3 formset-form">
                                    {{ addr_form.id }}
                                    {% if addr_form.non_field_errors %}
                                        <div class="alert alert-danger" role="alert">{{ addr_form.non_field_errors.0 }}</div>
                                    {% endif %}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ addr_form.receiver_name.id_for_label }}" class="form-label">
                                                收件人姓名 {% if addr_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ addr_form.receiver_name }}
                                            {% if addr_form.receiver_name.errors %}
                                                <div class="invalid-feedback d-block">{{ addr_form.receiver_name.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ addr_form.phone.id_for_label }}" class="form-label">
                                                联系电话 {% if addr_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ addr_form.phone }}
                                            {% if addr_form.phone.errors %}
                                                <div class="invalid-feedback d-block">{{ addr_form.phone.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="{{ addr_form.province.id_for_label }}" class="form-label">
                                                省份 {% if addr_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ addr_form.province }}
                                            {% if addr_form.province.errors %}
                                                <div class="invalid-feedback d-block">{{ addr_form.province.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="{{ addr_form.city.id_for_label }}" class="form-label">
                                                城市 {% if addr_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ addr_form.city }}
                                            {% if addr_form.city.errors %}
                                                <div class="invalid-feedback d-block">{{ addr_form.city.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="{{ addr_form.district.id_for_label }}" class="form-label">
                                                区/县 {% if addr_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            {{ addr_form.district }}
                                            {% if addr_form.district.errors %}
                                                <div class="invalid-feedback d-block">{{ addr_form.district.errors.0 }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ addr_form.address.id_for_label }}" class="form-label">
                                            详细地址 {% if addr_form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        {{ addr_form.address }}
                                        {% if addr_form.address.errors %}
                                            <div class="invalid-feedback d-block">{{ addr_form.address.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3 form-check">
                                        {{ addr_form.is_default }}
                                        <label class="form-check-label" for="{{ addr_form.is_default.id_for_label }}">设为默认地址</label>
                                        {% if addr_form.is_default.errors %}
                                            <div class="invalid-feedback d-block">{{ addr_form.is_default.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    {% if addr_form.instance.pk %}
                                        <div class="form-check">
                                            {{ addr_form.DELETE }}
                                            <label class="form-check-label text-danger" for="{{ addr_form.DELETE.id_for_label }}">删除此收货地址</label>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- 操作按钮 -->
                <div class="d-flex justify-content-end gap-2">
                    <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary btn-icon-text">
                        <i data-lucide="x-circle" class="btn-icon-prepend"></i> 取消
                    </a>
                    <button type="submit" class="btn btn-primary btn-icon-text">
                        <i data-lucide="check-circle" class="btn-icon-prepend"></i> 保存更改
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
        function workExperienceManager(initialCount) {
            return {
                formCount: initialCount,
                addForm() {
                    const formset = document.getElementById('work-formset');
                    const template = document.getElementById('work-form-template');
                    const newForm = template.content.cloneNode(true).querySelector('.formset-form');
                    newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, this.formCount);
                    formset.appendChild(newForm);
                    this.formCount++;
                    document.getElementById('id_work_experiences-TOTAL_FORMS').value = this.formCount;
                    if (window.lucide) {
                        lucide.createIcons();
                    }
                }
            }
        }

        function educationManager(initialCount) {
            return {
                formCount: initialCount,
                addForm() {
                    const formset = document.getElementById('education-formset');
                    const template = document.getElementById('education-form-template');
                    const newForm = template.content.cloneNode(true).querySelector('.formset-form');
                    newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, this.formCount);
                    formset.appendChild(newForm);
                    this.formCount++;
                    document.getElementById('id_educations-TOTAL_FORMS').value = this.formCount;
                    if (window.lucide) {
                        lucide.createIcons();
                    }
                }
            }
        }

        function addressManager(initialCount) {
            return {
                formCount: initialCount,
                addForm() {
                    const formset = document.getElementById('address-formset');
                    const template = document.getElementById('address-form-template');
                    const newForm = template.content.cloneNode(true).querySelector('.formset-form');
                    newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, this.formCount);
                    formset.appendChild(newForm);
                    this.formCount++;
                    document.getElementById('id_shipping_addresses-TOTAL_FORMS').value = this.formCount;
                    if (window.lucide) {
                        lucide.createIcons();
                    }
                }
            }
        }
    </script>
{% endblock extra_js %}
